## 부하 분산

### 로드 밸런서

> L4, L7은 OSI 7계층에서 어떠한 Layer에서 작동하는지를 뜻한다. L4는 Transport Layer, L7은 Application Layer를 의미한다.

- L4는 IP주소와 포트 번호를 사용하여 로드 밸런싱을 수행한다. TCP, UDP 기반 전송 계층 프로토콜을 사용하며, 성능과 속도 측면에서 L7보다 빠르다.
- L7은 HTTP, HTTPS, 헤더 및 요청 URL, 쿠키, 세션 등의 응용 계층의 특성을 기반으로 분산시킨다. 기능이 많은 반면 L4 보다 느리다.

분산 처리는 스위치나 라우터, 로드 밸런싱 전용 장비와 같은 하드웨어적 처리도 가능하지만 비용적인 문제로 소프트웨어적으로 처리할 수도 있어야 한다.

## 대용량 테이블의 처리 기법

회원 정보와 같은 경우 일정 수치를 넘어가면 더이상 크게 늘어나지 않는다. (국내 서비스 대상이라면 회원수가 수천만을 너어가면 더 이상 늘어나기 힘들것이다.) 이런 경우에는 쿼리 튜닝 정도로 성능 향상을 노려 볼 수 있을 것이다. 하지만 구매 내역과 같은 경우에는 이용자가 많을 경우 기하급수적으로 데이터가 쌓이게 될 것이다. 이럴 경우 어떻게 해결 할 수 있을지 DB 관점에서 생각해보자.

### Read, Write 분리와 복제

리플리케이션에 원본 데이터를 리얼타임에 근접하게 복사하여 자동으로 적재해 가용성과 안정성을 확보한다. 주 용도는 백업 및 복구이지만 대용량 처리를 위해서도 쓰인다. Read/Write를 수행하는 Master DB와 이를 복제하는 역할인 읽기 전용 Slave DB로 구성, 큰 읽기 작업이 필요할 경우 Slave DB에서 작업을 수행하게 함으로써 마스터 리소스 사용을 분담할 수 있음. DB는 운영 중 스케일 업을 하는게 어렵다. 따라서 가상 IP로 묶어 HA (High Availability)로 구축하는 것이 일반적. 즉, Slave 장비들을 스케일 아웃하여 확장하는 것이다. (단, Slave 장비의 사양이 낮으면 복제 지연이 발생하여 대량 데이터 처리시 버퍼 오버플로가 발생할 수 있음! 또한 HA는 새로 네트워크가 변경되어 Slave가 Master로 승격 될 경우, 역할이 변경되는 시간 차로 인해 네트워크 순단이 발생하여 데이터 소실이 발생할 수도 있음, 그러므로 Slave와 Master의 사양 차이는 최소화하는게 좋음)

### 파티셔닝

대량의 데이터를 여러개의 작은 단위(파티션)으로 나누어 저장하는 기법이다. 일반적으로는 물리적인 측면에서 나눈것이 아닌 논리적인 측면에서 테이블 분할 설계를 의미한다.

- 수직 파티셔닝
  - 테이블의 컬럼을 기준으로 분할
  - 특정 컬럼만 자주 조회하고, 나머지는 덜 조회할 경우 적합
- 수평 파티셔닝
  - 테이블 행을 기준으로 분할
  - 데이터가 너무 많을 때, 특정 조건(날짜 등)으로 자주 조회할 경우 - 특정 범위 데이터만 조회하는 경우
    - 예시) 연도별로 수평 파티셔닝을 했다면, 연도 기준으로 조회시 더 빠르게 조회가 가능하다.

### 샤딩

여러 개의 데이터베이스 서버로 분할 하여 저장하는 기법 (물리적으로 나눈 것, 동일 DB 서버에서 논리적으로 나눈게 파티셔닝이라면 샤딩은 물리적으로 각각의 DB 서버에 데이터를 나누어 저장)<br/>

샤딩은 DBMS에서 지원되는 스펙이 아니므로 애플리케이션 레벨에서 직접 구현해야 한다.

<br/>

**종류**

- 모듈러 샤딩 
  - 샤드키를 모듈러 연산한 결과로 DB 라우팅하는 방식
  - 레인지 샤딩에 비해 데이터가 균일하게 분산된다
  - DB를 추가 증설하는 과정에서 이미 적재된 데이터의 재정렬이 필요하다
- 레인지 샤딩
  - PK의 범위를 기준으로 DB를 라우팅하는 방식
  - 순차적으로 쌓이므로 DB증설시 재정렬 비용이 들지 않음
  - 데이터가 한 곳에 몰려서 특정 DB만 트래픽이 몰리게 될 수 있다.




###### 참고

- [대용량 세션을 위한 로드밸런서](https://d2.naver.com/helloworld/605418)

- [개발자 기술 면접 노트](https://www.yes24.com/Product/Goods/125554439?pid=123487&cosemkid=go17110158159320701&utm_source=google_pc&utm_medium=cpc&utm_campaign=book_pc&utm_content=ys_240530_google_pc_cc_book_pc_12403%EB%8F%84%EC%84%9C&utm_term=%EA%B0%9C%EB%B0%9C%EC%9E%90%EA%B8%B0%EC%88%A0%EB%A9%B4%EC%A0%91%EB%85%B8%ED%8A%B8&gad_source=1&gclid=Cj0KCQjwhr6_BhD4ARIsAH1YdjAEhhRrnuDDzUmdzlV_O4ysolU39Hi4EFdLPttOUL-mek4dkBlwL_0aAjHdEALw_wcB)
- [DB분산처리를 위한 sharding](https://techblog.woowahan.com/2687/)